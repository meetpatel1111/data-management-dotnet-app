name: Build Data Management App

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted

    steps:
    # ================= CHECKOUT =================
    - name: Checkout repository
      uses: actions/checkout@v3

    # ================= RESTORE =================
    - name: Restore Backend
      run: dotnet restore Backend.Api/Backend.Api.csproj

    - name: Restore Frontend
      run: dotnet restore Frontend.Web/Frontend.Web.csproj

    # ================= BUILD =================
    - name: Build Backend
      run: dotnet build Backend.Api/Backend.Api.csproj -c Release --no-restore

    - name: Build Frontend
      run: dotnet build Frontend.Web/Frontend.Web.csproj -c Release --no-restore

    # ================= ENSURE FOLDERS =================
    - name: Ensure deployment folders exist
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path C:\apps\data-management\backend -Force
        New-Item -ItemType Directory -Path C:\apps\data-management\frontend -Force

    # ================= BACKEND DEPLOY =================
    - name: Stop Backend (port 5000)
      shell: powershell
      run: |
        $ErrorActionPreference = "Continue"

        $conns = netstat -ano | Select-String ":5000"
        if ($conns) {
          $pids = $conns | ForEach-Object {
            ($_ -split '\s+')[-1]
          } | Sort-Object -Unique

          foreach ($processId in $pids) {
            Write-Host "Stopping backend PID=$processId"
            taskkill /PID $processId /F | Out-Null
          }
        } else {
          Write-Host "Backend not running"
        }

        # Wait until port is free (without failing the step)
        $timeout = 10
        while ((netstat -ano | Select-String ":5000") -and $timeout -gt 0) {
          Write-Host "Waiting for port 5000 to be released..."
          Start-Sleep -Seconds 1
          $timeout--
        }

        Write-Host "Backend stop completed"


    - name: Copy Backend DLLs
      shell: powershell
      run: |
        Copy-Item Backend.Api\bin\Release\net8.0\* `
          C:\apps\data-management\backend `
          -Recurse -Force

    - name: Start Backend
      shell: powershell
      run: |
        Start-Process "dotnet" `
          "C:\apps\data-management\backend\Backend.Api.dll --urls=http://localhost:5000"

    # ================= FRONTEND DEPLOY =================
    - name: Stop Frontend (port 5001)
      shell: powershell
      run: |
        $ErrorActionPreference = "Continue"

        $conns = netstat -ano | Select-String ":5001"
        if ($conns) {
          $pids = $conns | ForEach-Object {
            ($_ -split '\s+')[-1]
          } | Sort-Object -Unique

          foreach ($processId in $pids) {
            Write-Host "Stopping frontend PID=$processId"
            taskkill /PID $processId /F | Out-Null
          }
        } else {
          Write-Host "Frontend not running"
        }

        $timeout = 10
        while ((netstat -ano | Select-String ":5001") -and $timeout -gt 0) {
          Write-Host "Waiting for port 5001 to be released..."
          Start-Sleep -Seconds 1
          $timeout--
        }

        Write-Host "Frontend stop completed"


    - name: Copy Frontend DLLs
      shell: powershell
      run: |
        Copy-Item Frontend.Web\bin\Release\net8.0\* `
          C:\apps\data-management\frontend `
          -Recurse -Force

    - name: Start Frontend
      shell: powershell
      run: |
        Start-Process "dotnet" `
          "C:\apps\data-management\frontend\Frontend.Web.dll --urls=http://localhost:5001"
