name: Build Data Management App

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted

    steps:
    # ---------------- CHECKOUT ----------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ---------------- RESTORE ----------------
    - name: Restore Backend
      run: dotnet restore Backend.Api/Backend.Api.csproj

    - name: Restore Frontend
      run: dotnet restore Frontend.Web/Frontend.Web.csproj

    # ---------------- BUILD ----------------
    - name: Build Backend
      run: dotnet build Backend.Api/Backend.Api.csproj -c Release --no-restore

    - name: Build Frontend
      run: dotnet build Frontend.Web/Frontend.Web.csproj -c Release --no-restore

    # ---------------- ENSURE FOLDERS ----------------
    - name: Ensure deployment folders exist
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path C:\apps\data-management\backend -Force
        New-Item -ItemType Directory -Path C:\apps\data-management\frontend -Force

    # ================= BACKEND DEPLOY =================
    - name: Stop Backend (port 5000)
      shell: powershell
      run: |
        $conn = netstat -ano | findstr :5000
        if ($conn) {
          $processId = ($conn -split '\s+')[-1]
          Write-Host "Stopping backend processId=$processId"
          taskkill /PID $processId /F
        } else {
          Write-Host "Backend not running"
        }


    - name: Copy Backend DLLs
      shell: powershell
      run: |
        Copy-Item Backend.Api\bin\Release\net8.0\* C:\apps\data-management\backend -Recurse -Force

    - name: Start Backend
      shell: powershell
      run: |
        Start-Process "dotnet" `
          "C:\apps\data-management\backend\Backend.Api.dll --urls=http://localhost:5000"

    # ================= FRONTEND DEPLOY =================
    - name: Stop Frontend (port 5001)
      shell: powershell
      run: |
        $conn = netstat -ano | findstr :5001
        if ($conn) {
          $processId = ($conn -split '\s+')[-1]
          Write-Host "Stopping frontend processId=$processId"
          taskkill /PID $processId /F
        } else {
          Write-Host "Frontend not running"
        }


    - name: Copy Frontend DLLs
      shell: powershell
      run: |
        Copy-Item Frontend.Web\bin\Release\net8.0\* C:\apps\data-management\frontend -Recurse -Force

    - name: Start Frontend
      shell: powershell
      run: |
        Start-Process "dotnet" `
          "C:\apps\data-management\frontend\Frontend.Web.dll --urls=http://localhost:5001"
